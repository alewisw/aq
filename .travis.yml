language: cpp

compiler:  
    - gcc
     
git:
  depth: 1
  
install:
    - mkdir _Build
    - cd _Build
    - tar xf ../Tools/Linux/lcov_1.11.orig.tar.gz
    - sudo make -C lcov-1.11/ install
    - gem install coveralls-lcov
    - lcov --version
    
before_script: 
    - git clone --depth 1 https://${GITHUB_ACCESS_TOKEN}:x-oauth-basic@github.com/alewisw/aq.git --branch gh-pages --single-branch gh-pages
    - cd gh-pages
    - git config user.email "alewis.sw@gmail.com"
    - git config user.name "Travis CI"
    - cd ..
    - mkdir Coverage
    - cd Coverage
    - cmake ../.. -DCMAKE_BUILD_TYPE=COVERAGE
    - cd ..
    - mkdir Release
    - cd Release
    - cmake ../.. -DCMAKE_BUILD_TYPE=RELEASE
    - cd ..
    - mkdir Performance
    - cd Performance
    - cmake ../.. -DCMAKE_BUILD_TYPE=PERFORMANCE
    - cd ..

script: 
    - cd Coverage
    - make  
    - cd ..
    - cd Release
    - make  
    - cd ..
    - cd Performance
    - make  
    - cd ..
    - cd Release
    - ./UnitTest/UnitTest
    - cd ..
    - cd Coverage
    - lcov --rc lcov_branch_coverage=1 --directory . --zerocounters
    - ./UnitTest/UnitTest
    - lcov --rc lcov_branch_coverage=1 --directory . --capture --output-file coverage.info
    - lcov --rc lcov_branch_coverage=1 --remove coverage.info '/usr/*' 'TestLib/*' 'UnitTest/*' 'TraceBuffer.cpp' 'TraceBuffer.h' 'TraceManager.cpp' 'TraceManager.h' 'TestPointNotifier.cpp' 'TestPointNotifier.h' --output-file aq-coverage.info
    - lcov --rc lcov_branch_coverage=1 --list aq-coverage.info
    - coveralls-lcov --repo-token ${COVERALLS_REPO_TOKEN} aq-coverage.info
    - mkdir ../lcov-genhtml-UnitTest
    - genhtml --rc lcov_branch_coverage=1 --output-directory ../lcov-genhtml-UnitTest --title "AQ Unit Test Code Coverage" --num-spaces 4 aq-coverage.info
    - cd ../gh-pages
    - git pull --no-edit --commit origin gh-pages
    - cp -fr ../lcov-genhtml-UnitTest/* TravisCI/Coverage/UnitTest/
    - git add *
    - git commit -a -m "Updated code coverage results for UnitTest"
    - git pull --no-edit --commit origin gh-pages
    - git push origin gh-pages
    - cd ../Coverage
    - lcov --rc lcov_branch_coverage=1 --directory . --zerocounters
    - ./StressTest/StressTest -t6 -l1 -p3 -s1 -M932113 -P5 -A3:4:5:6 -T1000 -C -E -O30 -W3 -S500
    - ./StressTest/StressTest -t6 -l1 -p3 -s1 -M932113 -P5 -A3:4:5:6 -T1000 -L -O30 -S500 -1
    - ./StressTest/StressTest -t6 -l1 -p3 -s1 -M2113 -P5 -A7:9:11 -T1000 -L -O30 -S500 -2
    - ./StressTest/StressTest -t6 -l1 -p3 -s1 -M12113 -P5 -A3:4:5:6 -T1000 -O30 -S500 -3
    - lcov --rc lcov_branch_coverage=1 --directory . --capture --output-file coverage.info
    - lcov --rc lcov_branch_coverage=1 --remove coverage.info '/usr/*' 'TestLib/*' 'StressTest/*' 'TraceBuffer.cpp' 'TraceBuffer.h' 'TraceManager.cpp' 'TraceManager.h' 'TestPointNotifier.cpp' 'TestPointNotifier.h' --output-file aq-coverage.info
    - lcov --rc lcov_branch_coverage=1 --list aq-coverage.info
    - mkdir ../lcov-genhtml-StressTest
    - genhtml --rc lcov_branch_coverage=1 --output-directory ../lcov-genhtml-StressTest --title "AQ Stress Test Code Coverage" --num-spaces 4 aq-coverage.info
    - cd ../gh-pages
    - git pull --no-edit --commit origin gh-pages
    - cp -fr ../lcov-genhtml-StressTest/* TravisCI/Coverage/StressTest/
    - git add *
    - git commit -a -m "Updated code coverage results for StressTest"
    - git pull --no-edit --commit origin gh-pages
    - git push origin gh-pages
    - cd ../Performance
    - ./StressTest/StressTest -t6 -l50 -p3 -s1 -M932113 -P5 -A3:4:5:6 -T1000 -C -E -O30 -W3 -S3000 
    - ./PerfTest/PerfTest -m -c -d10 -t1:2:3:4 -M 
    
